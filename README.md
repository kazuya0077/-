# 理学療法士向け問診フォーム

地域おこし協力隊の理学療法士が、受診勧奨に必要な情報を整理できるように設計したウェブアプリケーションです。モダンな UI と選択式入力を軸に、転倒リスクサーベイや厚生労働省の身体活動基準を踏まえた質問項目を網羅しています。個人の住所・連絡先・妊娠出産歴などは収集せず、必要な機能情報に絞っています。

## 主な特長
- **ステップ進行型フォーム**：各セクションを 1 画面ずつ表示し、「次へ」「前へ」でスムーズに移動できます。サイドバーのステップナビから直接ジャンプすることも可能です。
- **必須項目の進捗表示**：介護度や 3KQ など必須項目の入力率をリアルタイムで表示し、漏れを防止します。
- **ローカル自動保存**：ブラウザに一時保存し、誤って閉じても入力内容を復元できます。保存データはワンクリックで削除可能です。
- **選択式の既往歴・感覚評価**：既往歴はチップ型の複数選択でサッと入力、しびれ・感覚障害は左右別にクリックできるボディマップと部位リストを用意しています。
- **身長・体重からの BMI 自動算出**：数値を入力すると BMI を自動計算し、手入力の手間や転記ミスを防ぎます。
- **生活状況の標準化**：睡眠・食生活は厚労省資料を踏まえた選択肢で整理し、必要な場合のみ追記欄を表示します。
- **生年月日と年齢の自動連動**：数字で生年月日を入力すると年齢を自動計算し、確認の手間を減らします。
- **送信前プレビュー**：入力内容をセクション別に整理したプレビューを表示し、確認後そのまま送信できます。
- **Google スプレッドシート連携**：指定の Apps Script エンドポイントへ JSON 送信し、スプレッドシートに記録します。

## ファイル構成
- `index.html` – フォーム本体。サイドバーやプレビューモーダルを含みます。
- `styles.css` – カード型レイアウト、ナビゲーション、モーダルなど UI コンポーネントのスタイル。
- `script.js` – 条件付き入力の表示制御、自動保存、プレビュー生成、Google スプレッドシート送信処理。
- `config.js` – Google Apps Script の Web アプリ URL を設定するためのファイル。
- `config.sample.js` – `config.js` を作成するときのサンプル。
- `google_apps_script.gs` – スプレッドシート側に配置する Google Apps Script（ウェブアプリ）。
- `dev-server.js` – ローカルプレビュー用の軽量 Node.js サーバー。
- `scripts/export-static.js` – Vercel など静的ホスティング向けの書き出しスクリプト。
- `vercel.json` – Vercel プロジェクト設定（静的書き出しと SPA ルーティング）。
- `package.json` – プレビュー・ビルドコマンド定義。

## ローカルでの利用方法
1. 依存パッケージをインストールし、開発サーバーを起動します。
   ```bash
   npm install
   npm run dev
   ```
   デフォルトでは `http://localhost:4173` でフォームを表示できます。ポートを変えたい場合は `npm run dev -- 3000` のように末尾に数値を指定してください。
2. 本番同様のビルドを確認する場合は `npm run build` を実行し、生成された `dist` ディレクトリを任意の静的ホスティングに配置します。
3. フォームに情報を入力すると、内容は自動的にブラウザへ一時保存されます。共有端末を利用する際は、フォーム左の「保存データを削除」ボタンでローカル保存を削除してください。

## Google スプレッドシート連携設定
1. Google スプレッドシート（ID: `1X3DzHP-7QIQABGola5QEvZJmpSSe7D9Sue-FWVY0x00`）で「問診回答」という名前のシートを用意します。
2. スプレッドシートで **拡張機能 → Apps Script** を開き、`google_apps_script.gs` の内容を貼り付けて保存します。
3. メニュー **公開 → ウェブアプリケーションとして導入** を選択し、
   - 新しいバージョンを作成
   - 実行するアプリ：`doPost`
   - アプリにアクセスできるユーザー：`全員（匿名含む）`
   として導入します。
4. 発行後に表示されるウェブアプリの URL を、プロジェクトルートの `config.js`（または `config.sample.js` をコピーしたファイル）の `window.APPS_SCRIPT_URL` に設定します。リポジトリでは共有用の URL（`https://script.google.com/macros/s/AKfycbw0JJSqhI68gud8S8jAV9EJxCPcIWfLoVlIGMl4_hTsJ3J7fYkrWJwKQ90McutIBUIJ-A/exec`）を既定値として同梱しています。Apps Script 側では CORS ヘッダーと `OPTIONS` リクエスト応答を含めているため、ブラウザから直接送信できます。
5. フォームを再読み込みし、テスト送信してスプレッドシートに行が追加されることを確認してください。

### 項目を追加・編集する場合
- HTML の該当ラベルやセレクトボックスを編集し、必要に応じて `data-conditional` 属性を設定してください。
- スプレッドシートの 1 行目（ヘッダー）に同じ名前の列があるか確認します。Apps Script は新しいキーを受信した際に列を自動追加しますが、列順を揃えたい場合は手動で調整してください。
- `script.js` の自動保存・プレビュー機能は `name` 属性を基準に動作します。重複しない一意の `name` を設定してください。

## Vercel へのデプロイ
1. Vercel CLI を利用する場合は `npm install -g vercel` を実行し、プロジェクトルートで `vercel login` のあと `vercel` を実行します。
2. 初回デプロイ時に以下のように設定してください。
   - **Framework Preset**: `Other`
   - **Build Command**: `npm run build`
   - **Output Directory**: `dist`
3. コマンドが完了するとプレビュー用の URL（Preview Deployment）が発行され、同じ設定で `vercel --prod` を実行すると本番 URL が更新されます。
4. GUI から設定する場合も Build Command を `npm run build`、Output を `dist` に設定すれば同じ結果が得られます。
5. 以後は `npm run build` で `dist` ディレクトリに静的ファイルが書き出されるため、任意の静的ホスティングサービスへアップロードすることも可能です。

## 注意事項
- フォームには個人情報が含まれるため、公開範囲やアクセス管理に注意してください。
- Apps Script を公開すると URL を知る全てのユーザーからアクセス可能となります。必要に応じて追加の認証方法を導入してください。
- フォームでは氏名や年齢など最小限の個人情報のみを扱います。スプレッドシートの共有範囲にも十分ご注意ください。
